{% extends "layout.html" %}

{% block title %}Workshop - NightreignBuilder{% endblock %}

{% block content %}
    <div style="display: flex; gap: 30px; margin-top: 40px">
        <div id="Character_main">
            <img src="/static/images/character_models/{{ character.image }}" alt="{{ character.name }} Model" style="width: 200px; height: auto; border: 2px solid #000; border-radius: 10px;">
            <h2 class="below_character" id="head">{{ character.name }}</h2>
            <h4 class="below_character">Role: {{ character.role }}</h4>
            <h4 class="below_character">Description: {{ character.description }}</h4>
        </div>
        <div>
            <p>Main Weapon: {{ character.main_weapon }}</p>
            <p>Secondary Weapon: {{ character.secondary_weapon }}</p>
            <p>Passive: {{ character.passive }}</p>
            <p>Skill: {{ character.skill }}</p>
            <p>Ultimate: {{ character.ultimate }}</p>
            <p>Vigor: {{ character.vigor }}</p>
            <p>FP: {{ character.fp }}</p>
            <p>Endurance: {{ character.endurance }}</p>
        </div>
        <div>
            <p>STR: {{ character.STR }}</p>
            <p>DEX: {{ character.DEX }}</p>
            <p>INT: {{ character.INT }}</p>
            <p>FAI: {{ character.FAI }}</p>
            <p>ARC: {{ character.ARC }}</p>
        </div>
    </div>
    <div class="divider"></div>
    <div class="dropdown" id="chaliceDropdown">
        <button class="btn btn-dark dropdown-toggle" type="button" id="workshopDropdown" data-bs-toggle="dropdown" data-bs-auto-close="true" aria-expanded="false">
            Chalices
        </button>
        <ul class="dropdown-menu" aria-labelledby="workshopDropdown">
            <!-- Global Chalices -->
            {% for chalice in global_chalices %}
            <li>
                <a class="dropdown-item" href="#">
                    <img src="{{ url_for('static', filename=chalice.img_base.replace('static/', '')) }}"
                        alt="{{ chalice.name }}"
                        style="width: 50px; height: auto;">
                    {{ chalice.name | format_name }}
                </a>
            </li>
            {% endfor %}
            <!-- Character-Specific Chalices -->
            {% for chalice in character_chalices %}
            <li>
                <a class="dropdown-item" href="#">
                    <img src="{{ url_for('static', filename=chalice.img_base.replace('static/', '')) }}"
                        alt="{{ chalice.name }}"
                        style="width: 50px; height: auto;">
                    {{ chalice.name | format_name }}
                </a>
            </li>
            {% endfor %}
        </ul>
    </div>
    
    <div>
        <table id="chalice_box">
            <tr>
                <td class="relic_slot">
                    <img class="relic_slot_color" id="0" src="" alt="">
                </td>
                <td class="relic_slot">
                    <img class="relic_slot_color" id="1" src="" alt="">
                </td>
                <td class="relic_slot">
                    <img class="relic_slot_color" id="2" src="" alt="">
                </td>
                <td class="relic_slot">
                    <img class="relic_slot_color" id="3" src="" alt="">
                </td>
                <td class="relic_slot">
                    <img class="relic_slot_color" id="4" src="" alt="">
                </td>
                <td class="relic_slot">
                    <img class="relic_slot_color" id="5" src="" alt="">
                </td>
            </tr>
        </table>
    </div>

    <script>
        // Update chalice dropdown button text and load slots on selection
        document.querySelectorAll('#chaliceDropdown .dropdown-item').forEach(item => {
            item.addEventListener('click', function(event) {
                event.preventDefault();
                const selectedChalice = this.textContent.trim();
                document.getElementById('workshopDropdown').textContent = selectedChalice;
                
                // Call API to get slot colors for this chalice
                fetch(`/api/chalice-slots/${encodeURIComponent(selectedChalice)}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Chalice not found');
                        }
                        return response.json();
                    })
                    .then(data => {
                        // Update each slot image with the correct color
                        data.colors.forEach((color, index) => {
                            const slotImg = document.getElementById(index.toString());
                            slotImg.src = `/static/images/relic_colors/${color}.png`;
                            slotImg.alt = `${color} Slot`;
                        });
                    })
                    .catch(error => {
                        console.error('Error loading chalice slots:', error);
                        // Default to white slots on error
                        for (let i = 0; i < 6; i++) {
                            const slotImg = document.getElementById(i.toString());
                            slotImg.src = "/static/images/relic_colors/white.png";
                            slotImg.alt = "Empty Slot";
                        }
                    });
            });
        });
        
        // Initialize slots to white on page load
        for (let i = 0; i < 6; i++) {
            document.getElementById(i.toString()).src = "/static/images/relic_colors/white.png";
            document.getElementById(i.toString()).alt = "Empty Slot";
        }
    </script>
    </script>
{% endblock %}